<!DOCTYPE HTML>
<html>
  <head>
  	<script type="text/javascript" src="Scripts/jquery-2.1.1.min.js"></script>  	
    <style>
      body {
        margin: 0px auto;
        background-color: #545454;
      }      
      canvas {
      	border: 1px dotted #000;
      	background-color: #fff;
      	cursor: crosshair;
      }
      #toolbar div {
      	width: 50px;
      	border: 1px solid #000;
      	background-color: #efefef;
      	cursor: pointer;
      	display: inline;
      }
      #toolbar div.active {
      	background-color: red;
      }
    </style>
  </head>
  <body>
    <center>
    	<div id="container"></div>
    	<div id="toolbar"></div>
    </center>
    
    <script>
      function Canvas(container, toolbar) {
      	this.canvas = $("<canvas></canvas>");   
      	this.context = null;
      	this.rectangle = null;
      	this.height = 600;
      	this.width = 1000;
      	this.container = container;
      	this.inputManager = null;      	
      	this.toolbar = toolbar;
      	var self = this;

		this.draw = function(e) {
			if (!this.shouldDraw()){
				return;
			}
			console.log(this.canvas[0].toDataURL());
      		this.toolbar.draw(this.context, this.inputManager);
      	};

      	this.shouldDraw = function() {
      		return this.inputManager.mouse.isDown;
      	};

      	this.render = function() {
      		this.canvas.attr({'height' : this.height, 'width' : this.width});
      		this.container.html(this.canvas);
      		$(this.canvas).on("mousemove", function(e) {
      			self.draw(e);
      		});      		
      		this.context = this.canvas[0].getContext('2d');
      		this.inputManager = new InputManager(this.canvas);
      		this.inputManager.bind();
      		this.toolbar.render();
      	};      	
      };

      function InputManager(container) {
      	this.container = container;
      	this.mouse = new Mouse();
      	var self = this;

      	this.bind = function() {      		
      		this.container.on("mousedown", function(e) {
      			self.mouse.mouseDown();
      		});

      		this.container.on("mouseup", function(e) {
      			self.mouse.mouseUp();
      		});

      		this.container.on("mousemove", function(e) {      		
      			self.mouse.updatePosition(e, self.container[0]);
      		});

      		this.container.on("mouseout", function(e) {
      			self.mouse.mouseOut();
      		});
      	};
      }

      function Toolbar(container) {
      	this.container = container;
      	this.buttons = [new PencilButton(this.container), new EraserButton(this.container)];
      	this.activeButton = this.buttons[0];
      	var self = this;

      	this.render = function() {
      		$.each(this.buttons, function(i, button) {   
      			button.render();
      			button.bind(function() {
      				self.activeButton.deactivate();
      				self.activeButton = button;
      				self.activeButton.activate();
      			});
      		});
      	};

      	this.draw = function(context, inputManager) {
      		this.activeButton.draw(context, inputManager);
      	};
      }

      function PencilButton(container) {
		this.container = container;
		var self = this;

      	this.render = function() {
      		return self.container.append($("<div id='pencil'>Crazy Pencil</div>"));
      	};

      	this.bind = function(callback) {
      		self.container.find('#pencil').on("click", function(e) {
      			callback();
      		});
      	};

      	this.activate = function() {
      		self.container.find($("#pencil").addClass("active"));
      	};

      	this.deactivate = function() {
			self.container.find($("#pencil").removeClass("active"));
      	};

      	this.draw = function(context, inputManager) {
			context.beginPath();
			context.strokeStyle = '#000000';
	      	context.moveTo(inputManager.mouse.lastX, inputManager.mouse.lastY);
	      	context.lineTo(inputManager.mouse.X, inputManager.mouse.Y);
	      	context.lineWidth = 15;
	      	context.stroke();	      	
      	}
      }

      function EraserButton(container) {
      	this.container = container;
      	var self = this;

      	this.render = function() {
      		return self.container.append($("<div id='eraser'>Crazy Eraser</div>"));
      	};

      	this.bind = function(callback) {
      		self.container.find('#eraser').on("click", function(e) {
      			callback();
      		});
      	};

      	this.activate = function() {
      		self.container.find($("#eraser").addClass("active"));
      	};

      	this.deactivate = function() {
			self.container.find($("#eraser").removeClass("active"));
      	};

      	this.draw = function(context, inputManager) {
			context.beginPath();
			context.strokeStyle = '#ffffff';
	      	context.moveTo(inputManager.mouse.lastX, inputManager.mouse.lastY);
	      	context.lineTo(inputManager.mouse.X, inputManager.mouse.Y);
	      	context.lineWidth = 50;
	      	context.stroke();
      	}
      }

      function Mouse() {
      	this.lastX = null;
      	this.lastY = null;
      	this.X = null;
      	this.Y = null;
      	this.isDown = false;
      	var self = this;

      	this.updatePosition = function(e, canvas) {
      		var rectangle = canvas.getBoundingClientRect();
      		this.lastX = this.X;
      		this.lastY = this.Y;
      		this.X = e.clientX - rectangle.left;
      		this.Y = e.clientY - rectangle.top;
      	}

      	this.mouseDown = function() {
      		this.isDown = true;
      	}

      	this.mouseUp = function() {
      		this.isDown = false;
      	}

      	this.mouseOut = function() {
      		this.isDown = false;
      	}
      }

      $(function() {
      	var toolbar = new Toolbar($("#toolbar"));
      	var canvas = new Canvas($("#container"), toolbar);
      	canvas.render();
      });
    </script>
  </body>
</html> 